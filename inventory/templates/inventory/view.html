{% extends "base.html" %}

{% block title %}{{ item.name }} - {{ _('Inventory Item') }} - {{ _('Business Management System') }}{% endblock %}

{% block content %}
<!-- Header -->
<div class="mb-6">
    <div class="flex items-center justify-between">
        <div class="flex items-center space-x-4">
            <a href="{{ url_for('inventory.index', company_id=company_id) }}"
                class="text-fg-muted hover:text-fg-base transition">
                <i class="fas fa-arrow-left"></i>
            </a>
            <div>
                <h2 class="text-2xl font-bold text-fg-base">{{ item.name }}</h2>
                <p class="text-fg-muted text-sm mt-1">{{ _('Inventory Item Details') }}</p>
            </div>
        </div>
        <div class="flex space-x-3">
            <a href="{{ url_for('inventory.edit', company_id=company_id, id=item.id) }}"
                class="bg-btn-secondary-bg text-btn-secondary-text px-4 py-2 rounded-lg hover:bg-btn-secondary-hover transition flex items-center">
                <i class="fas fa-edit mr-2"></i>{{ _('Edit') }}
            </a>
            <form action="{{ url_for('inventory.delete', company_id=company_id, id=item.id) }}" method="POST"
                class="inline">
                <input type="hidden" id="csrf_token" name="csrf_token" value="{{ csrf_token() }}">
                <button type="submit"
                    class="bg-btn-danger-bg text-btn-danger-text px-4 py-2 rounded-lg hover:bg-btn-danger-hover transition flex items-center"
                    onclick="return confirm('{{ _('Are you sure you want to delete this item?') }}')">
                    <i class="fas fa-trash mr-2"></i>{{ _('Delete') }}
                </button>
            </form>
        </div>
    </div>
</div>

<div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
    <!-- Main Details -->
    <div class="lg:col-span-2 space-y-6">
        <!-- Item Information -->
        <div class="bg-bg-subtle rounded-xl shadow-sm border border-primary-200 p-6">
            <h3 class="text-lg font-medium text-fg-base mb-4">{{ _('Item Information') }}</h3>

            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-fg-muted mb-1">{{ _('Name') }}</label>
                    <p class="text-fg-base font-medium">{{ item.name }}</p>
                </div>

                {% if item.description %}
                <div>
                    <label class="block text-sm font-medium text-fg-muted mb-1">{{ _('Description') }}</label>
                    <p class="text-fg-base">{{ item.description }}</p>
                </div>
                {% endif %}

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-fg-muted mb-1">{{ _('Current Quantity')
                            }}</label>
                        <div class="flex items-center space-x-2">
                            <span class="text-2xl font-bold text-fg-base">{{ item.quantity }}</span>
                            <span class="px-2 py-1 text-xs rounded-full font-medium
                                    {% if item.quantity == 0 %}bg-btn-danger-bg text-btn-danger-text
                                    {% elif item.quantity <= 10 %}bg-btn-alert-bg text-btn-alert-text
                                    {% else %}bg-accent-200 text-accent-800{% endif %}">
                                {% if item.quantity == 0 %}{{ _('Out of Stock') }}
                                {% elif item.quantity <= 10 %}{{ _('Low Stock') }} {% else %}{{ _('In Stock') }}{% endif
                                    %} </span>
                        </div>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-fg-muted mb-1">{{ _('Unit Price') }}</label>
                        <p class="text-2xl font-bold text-fg-base">{{ session.get('currency') }}{{ "{:,.2f}".format(item.price) }}</p>
                    </div>
                </div>

                {% if item.supplier %}
                <div>
                    <label class="block text-sm font-medium text-fg-muted mb-1">{{ _('Supplier') }}</label>
                    <p class="text-fg-base">{{ item.supplier.name }}</p>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- Barcode Section -->
        <div class="bg-bg-subtle rounded-xl shadow-sm border border-primary-200 p-6">
            <h3 class="text-lg font-medium text-fg-base mb-4">{{ _('Barcode') }}</h3>

            <div class="space-y-4">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm text-fg-muted">{{ _('Item Code') }}</p>
                        <p class="text-lg font-mono text-fg-base">{{ company_id }}{{ "%06d"|format(item.id) }}</p>
                    </div>
                    <div class="flex space-x-2">
                        <button type="button" onclick="viewBarcode()"
                            class="bg-btn-secondary-bg text-btn-secondary-text px-4 py-2 rounded-lg hover:bg-btn-secondary-hover transition flex items-center">
                            <i class="fas fa-eye mr-2"></i>{{ _('View Barcode') }}
                        </button>
                        <a href="{{ url_for('inventory.download_barcode', company_id=company_id, id=item.id) }}"
                            class="bg-btn-primary-bg text-btn-primary-text px-4 py-2 rounded-lg hover:bg-btn-primary-hover transition flex items-center">
                            <i class="fas fa-download mr-2"></i>{{ _('Download') }}
                        </a>
                    </div>
                </div>

                <!-- Barcode Display Area -->
                <div id="barcode-container" class="hidden">
                    <div class="bg-bg-base border border-primary-200 rounded-lg p-4 text-center">
                        <img id="barcode-image" src="/placeholder.svg" alt="{{ _('Barcode') }}"
                            class="mx-auto max-w-full h-auto">
                        <p class="text-sm text-fg-muted mt-2">{{ _('Barcode for') }} {{ item.name }}</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Sidebar -->
    <div class="space-y-6">
        <!-- Stock Management -->
        <div class="bg-bg-subtle rounded-xl shadow-sm border border-primary-200 p-6">
            <h3 class="text-lg font-medium text-fg-base mb-4">{{ _('Stock Management') }}</h3>

            <div class="space-y-4">
                <div class="flex items-center justify-between">
                    <span class="text-sm text-fg-muted">{{ _('Total Value') }}</span>
                    <span class="font-bold text-fg-base">{{ session.get('currency') }}{{ "{:,.2f}".format(item.quantity * item.price) }}</span>
                </div>

                <div class="flex space-x-2">
                    <button type="button"
                        class="stock-adjust-btn flex-1 bg-btn-danger-bg text-btn-danger-text px-3 py-2 rounded-lg hover:bg-btn-danger-hover transition text-sm"
                        data-item-id="{{ item.id }}" data-adjustment="-1">
                        <i class="fas fa-minus mr-1"></i>{{ _('Remove 1') }}
                    </button>
                    <button type="button"
                        class="stock-adjust-btn flex-1 bg-accent-500 text-accent-900 px-3 py-2 rounded-lg hover:bg-accent-600 transition text-sm"
                        data-item-id="{{ item.id }}" data-adjustment="1">
                        <i class="fas fa-plus mr-1"></i>{{ _('Add 1') }}
                    </button>
                </div>

                <button type="button"
                    class="w-full bg-btn-secondary-bg text-btn-secondary-text px-3 py-2 rounded-lg hover:bg-btn-secondary-hover transition text-sm"
                    onclick="showStockAdjustModal()">
                    <i class="fas fa-edit mr-1"></i>{{ _('Custom Adjustment') }}
                </button>
            </div>
        </div>

        <!-- Item Status -->
        <div class="bg-accent-50 rounded-xl shadow-sm border border-accent-200 p-6">
            <h3 class="text-lg font-medium text-fg-base mb-4">{{ _('Item Status') }}</h3>

            <div class="space-y-3">
                <div class="flex justify-between items-center">
                    <span class="text-sm text-fg-muted">{{ _('Stock Level') }}</span>
                    <span class="px-2 py-1 text-xs rounded-full font-medium
                            {% if item.quantity == 0 %}bg-btn-danger-bg text-btn-danger-text
                            {% elif item.quantity <= 10 %}bg-btn-alert-bg text-btn-alert-text
                            {% else %}bg-accent-200 text-accent-800{% endif %}">
                        {% if item.quantity == 0 %}{{ _('Critical') }}
                        {% elif item.quantity <= 10 %}{{ _('Low') }} {% else %}{{ _('Good') }}{% endif %} </span>
                </div>

                <div class="flex justify-between items-center">
                    <span class="text-sm text-fg-muted">{{ _('Value Status') }}</span>
                    <span class="text-sm font-medium text-fg-base">
                        {% if item.quantity * item.price > 1000 %}{{ _('High Value') }}
                        {% elif item.quantity * item.price > 100 %}{{ _('Medium Value') }}
                        {% else %}{{ _('Low Value') }}{% endif %}
                    </span>
                </div>
            </div>
        </div>

        <!-- Barcode Actions -->
        <div class="bg-bg-subtle rounded-xl shadow-sm border border-primary-200 p-6">
            <h3 class="text-lg font-medium text-fg-base mb-4">{{ _('Barcode Actions') }}</h3>

            <div class="space-y-3">
                <button type="button" onclick="viewBarcode()"
                    class="w-full bg-btn-secondary-bg text-btn-secondary-text px-4 py-2 rounded-lg hover:bg-btn-secondary-hover transition flex items-center justify-center">
                    <i class="fas fa-barcode mr-2"></i>{{ _('View Barcode') }}
                </button>

                <a href="{{ url_for('inventory.download_barcode', company_id=company_id, id=item.id) }}"
                    class="w-full bg-btn-primary-bg text-btn-primary-text px-4 py-2 rounded-lg hover:bg-btn-primary-hover transition flex items-center justify-center">
                    <i class="fas fa-download mr-2"></i>{{ _('Download PNG') }}
                </a>

                <button type="button" onclick="printBarcode()"
                    class="w-full bg-accent-500 text-accent-900 px-4 py-2 rounded-lg hover:bg-accent-600 transition flex items-center justify-center">
                    <i class="fas fa-print mr-2"></i>{{ _('Print Barcode') }}
                </button>
            </div>

            <div class="mt-4 pt-4 border-t border-primary-200">
                <p class="text-xs text-fg-muted">
                    {{ _('Barcode format: Code128') }}<br>
                    {{ _('Item code: %(code)s', code=company_id ~ ("%06d"|format(item.id))) }}
                </p>
            </div>
        </div>
    </div>
</div>

<!-- Stock Adjustment Modal -->
<div id="stockAdjustModal" class="fixed inset-0 bg-black/50 hidden items-center justify-center z-50">
    <div class="bg-bg-subtle rounded-xl shadow-xl max-w-md w-full mx-4">
        <div class="p-6">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-medium text-fg-base">{{ _('Adjust Stock Level') }}</h3>
                <button type="button" onclick="hideStockAdjustModal()" class="text-fg-muted hover:text-fg-base">
                    <i class="fas fa-times"></i>
                </button>
            </div>

            <form id="stock-adjust-form">
                <div class="mb-4">
                    <label for="adjustment" class="block text-sm font-medium text-fg-base mb-2">{{ _('Adjustment
                        Amount') }}</label>
                    <input type="number" id="adjustment" name="adjustment"
                        class="w-full px-3 py-2 border border-primary-300 rounded-lg focus:ring-accent-500 focus:border-accent-500 bg-bg-base text-fg-base"
                        placeholder="{{ _('Enter positive or negative number') }}">
                    <p class="text-xs text-fg-muted mt-1">{{ _('Use positive numbers to add stock, negative to remove')
                        }}</p>
                </div>

                <div class="flex justify-end space-x-3">
                    <button type="button" onclick="hideStockAdjustModal()"
                        class="px-4 py-2 bg-btn-secondary-bg text-btn-secondary-text rounded-lg hover:bg-btn-secondary-hover transition">
                        {{ _('Cancel') }}
                    </button>
                    <button type="submit"
                        class="px-4 py-2 bg-btn-primary-bg text-btn-primary-text rounded-lg hover:bg-btn-primary-hover transition">
                        {{ _('Adjust Stock') }}
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Barcode Print Modal -->
<div id="barcodePrintModal" class="fixed inset-0 bg-black/50 hidden items-center justify-center z-50">
    <div class="bg-bg-subtle rounded-xl shadow-xl max-w-lg w-full mx-4">
        <div class="p-6">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-medium text-fg-base">{{ _('Print Barcode') }}</h3>
                <button type="button" onclick="hideBarcodeModal()" class="text-fg-muted hover:text-fg-base">
                    <i class="fas fa-times"></i>
                </button>
            </div>

            <div class="text-center mb-6">
                <img id="print-barcode-image" src="/placeholder.svg" alt="{{ _('Barcode') }}"
                    class="mx-auto max-w-full h-auto bg-bg-base p-4 rounded-lg border border-primary-200">
                <div class="mt-4 space-y-2">
                    <p class="font-medium text-fg-base">{{ item.name }}</p>
                    <p class="text-sm text-fg-muted">{{ _('Code: %(code)s', code=company_id ~ ("%06d"|format(item.id)))
                        }}</p>
                    <p class="text-sm text-fg-muted">{{ _('Price: $%(price)s', price="%.2f"|format(item.price)) }}</p>
                </div>
            </div>

            <div class="flex justify-end space-x-3">
                <button type="button" onclick="hideBarcodeModal()"
                    class="px-4 py-2 bg-btn-secondary-bg text-btn-secondary-text rounded-lg hover:bg-btn-secondary-hover transition">
                    {{ _('Cancel') }}
                </button>
                <button type="button" onclick="window.print()"
                    class="px-4 py-2 bg-btn-primary-bg text-btn-primary-text rounded-lg hover:bg-btn-primary-hover transition">
                    {{ _('Print') }}
                </button>
            </div>
        </div>
    </div>
</div>

<script>
    const pathParts = window.location.pathname.split('/');
    const companyId = pathParts[1];
    const itemId = pathParts[3];
    const csrf_token = document.getElementById('csrf_token').value;

    document.addEventListener('DOMContentLoaded', function () {
        // Stock adjustment functionality
        document.querySelectorAll('.stock-adjust-btn').forEach(button => {
            button.addEventListener('click', function () {
                const adjustment = parseInt(this.dataset.adjustment);
                adjustStock(adjustment);
            });
        });

        // Custom stock adjustment form
        document.getElementById('stock-adjust-form').addEventListener('submit', function (e) {
            e.preventDefault();
            const adjustment = parseInt(document.getElementById('adjustment').value);
            if (!isNaN(adjustment)) {
                adjustStock(adjustment);
                hideStockAdjustModal();
            }
        });

        function adjustStock(adjustment) {
            fetch(`/api/${companyId}/inventory/items/${itemId}/adjust-stock`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrf_token
                },
                body: JSON.stringify({ adjustment: adjustment })
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        location.reload(); // Reload to show updated values
                    } else {
                        alert(data.error || '{{ _("An error occurred") }}');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('{{ _("An error occurred") }}');
                });
        }
    });

    function showStockAdjustModal() {
        document.getElementById('stockAdjustModal').classList.remove('hidden');
        document.getElementById('stockAdjustModal').classList.add('flex');
        document.getElementById('adjustment').focus();
    }

    function hideStockAdjustModal() {
        document.getElementById('stockAdjustModal').classList.add('hidden');
        document.getElementById('stockAdjustModal').classList.remove('flex');
        document.getElementById('adjustment').value = '';
    }

    function viewBarcode() {
        const barcodeContainer = document.getElementById('barcode-container');
        const barcodeImage = document.getElementById('barcode-image');

        // Show loading state
        barcodeImage.src = '';
        barcodeContainer.classList.remove('hidden');

        // Load barcode image
        barcodeImage.src = `/${companyId}/inventory/${itemId}/barcode`;
        barcodeImage.onload = function () {
            // Scroll to barcode
            barcodeContainer.scrollIntoView({ behavior: 'smooth', block: 'center' });
        };
    }

    function printBarcode() {
        const modal = document.getElementById('barcodePrintModal');
        const printImage = document.getElementById('print-barcode-image');

        // Load barcode image
        printImage.src = `/${companyId}/inventory/${itemId}/barcode`;

        // Show modal
        modal.classList.remove('hidden');
        modal.classList.add('flex');
    }

    function hideBarcodeModal() {
        document.getElementById('barcodePrintModal').classList.add('hidden');
        document.getElementById('barcodePrintModal').classList.remove('flex');
    }

    // Print styles for barcode modal
    const printStyles = `
    @media print {
        body * {
            visibility: hidden;
        }
        #barcodePrintModal, #barcodePrintModal * {
            visibility: visible;
        }
        #barcodePrintModal {
            position: absolute;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: white !important;
        }
        .bg-black {
            background: white !important;
        }
    }
`;

    // Add print styles to head
    const styleSheet = document.createElement('style');
    styleSheet.textContent = printStyles;
    document.head.appendChild(styleSheet);
</script>
{% endblock %}