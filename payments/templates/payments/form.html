{% extends "base.html" %}

{% block title %}{% if payment %}{{ _('Edit Payment') }}{% else %}{{ _('Record Payment') }}{% endif %} - {{ _('Business
Management System') }}{% endblock %}

{% block content %}
<div class="animate-fadeIn">
    <div class="flex justify-between items-center mb-6">
        <div>
            <h2 class="text-2xl font-bold text-fg-base">{% if payment %}{{ _('Edit Payment') }}{% else %}{{ _('Record
                Payment') }}{% endif %}</h2>
            <p class="text-fg-muted text-sm mt-1">{% if payment %}{{ _('Update payment details') }}{% else %}{{
                _('Record a new payment') }}{% endif %}</p>
        </div>
        <div>
            <a href="{{ url_for('payments.index', company_id=session.get('selected_company_id')) }}"
                class="bg-btn-secondary-bg text-btn-secondary-text px-4 py-2 rounded-lg hover:bg-btn-secondary-hover transition flex items-center">
                <i class="fas fa-arrow-left mr-2"></i> {{ _('Back to Payments') }}
            </a>
        </div>
    </div>

    <!-- Payment Form -->
    <div class="bg-bg-subtle rounded-xl shadow-sm p-6 border border-secondary-200">
        <form id="payment-form"
            action="{% if payment %}{{ url_for('payments.update', company_id=session.get('selected_company_id'), id=payment.id) }}{% else %}{{ url_for('payments.store', company_id=session.get('selected_company_id')) }}{% endif %}"
            method="POST">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            <input type="hidden" id="document_id" name="document_id"
                value="{{ selected_invoice.id if selected_invoice else (payment.document_id if payment else '') }}">

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                <!-- Invoice Selection -->
                <div class="md:col-span-2">
                    <label for="invoice_search" class="block text-sm font-medium text-fg-base mb-1">
                        {{ _('Invoice') }}
                    </label>
                    <div class="relative">
                        <input type="text" id="invoice_search" placeholder="{{ _('Search for an invoice...') }}"
                            class="w-full px-3 py-2 border border-secondary-200 rounded-lg focus:ring-accent-500 focus:border-accent-500 bg-bg-base text-fg-base"
                            value="{% if selected_invoice %}{{ selected_invoice.document_number }} - {{ selected_invoice.client.name if selected_invoice.client else 'No Client' }}{% endif %}">
                        <div id="invoice_dropdown"
                            class="absolute z-10 w-full bg-bg-base border border-secondary-200 rounded-lg shadow-lg mt-1 hidden max-h-60 overflow-y-auto">
                            <!-- Search results will be populated here -->
                        </div>
                    </div>
                    <p class="text-xs text-fg-muted mt-1">{{ _('Start typing to search for invoices by number or client
                        name') }}</p>

                    <!-- Selected Invoice Display -->
                    <div id="selected_invoice" class="mt-3 {% if not selected_invoice %}hidden{% endif %}">
                        <div class="bg-accent-50 border border-accent-200 rounded-lg p-4">
                            <div class="flex justify-between items-start">
                                <div>
                                    <h4 class="font-medium text-fg-base" id="selected_invoice_number">
                                        {% if selected_invoice %}{{ selected_invoice.document_number }}{% endif %}
                                    </h4>
                                    <p class="text-sm text-fg-muted" id="selected_invoice_client">
                                        {% if selected_invoice and selected_invoice.client %}
                                        {{ selected_invoice.client.name }}
                                        {% endif %}
                                    </p>
                                    <div class="grid grid-cols-2 gap-4 mt-2 text-sm">
                                        <div>
                                            <span class="text-fg-muted">{{ _('Total Amount') }}:</span>
                                            <span class="font-medium" id="selected_invoice_total">
                                                {% if selected_invoice %} 
                                                {{ session.get('currency') }}{{ "{:,.2f}".format(selected_invoice.total_amount or 0) }}
                                                {% endif %}
                                            </span>
                                        </div>
                                        <div>
                                            <span class="text-fg-muted">{{ _('Remaining Balance') }}:</span>
                                            <span class="font-medium text-accent-600" id="selected_invoice_balance">
                                                {% if selected_invoice %} 
                                                {{ session.get('currency') }}{{ "{:,.2f}".format(selected_invoice.total_amount or 0) }}
                                                {% endif %}
                                            </span>
                                        </div>
                                    </div>
                                </div>
                                <button type="button" id="clear_invoice" class="text-fg-muted hover:text-fg-base">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Payment Amount -->
                <div>
                    <label for="amount" class="block text-sm font-medium text-fg-base mb-1">{{ _('Payment Amount') }}
                        <span class="text-btn-danger-bg">*</span></label>
                    <div class="relative">
                        <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                            <span class="text-fg-muted">{{ session.get('currency') }}</span>
                        </div>
                        <input type="number" id="amount" name="amount" step="0.01" min="0"
                            value="{{ payment.amount if payment else '' }}" required
                            class="w-full pl-8 pr-3 py-2 border border-secondary-200 rounded-lg focus:ring-accent-500 focus:border-accent-500 bg-bg-base text-fg-base">
                    </div>
                </div>

                <!-- Payment Date -->
                <div>
                    <label for="payment_date" class="block text-sm font-medium text-fg-base mb-1">{{ _('Payment Date')
                        }} <span class="text-btn-danger-bg">*</span></label>
                    <input type="date" id="payment_date" name="payment_date" required
                        value="{{ payment.payment_date.strftime('%Y-%m-%d') if payment and payment.payment_date else '' }}"
                        class="w-full px-3 py-2 border border-secondary-200 rounded-lg focus:ring-accent-500 focus:border-accent-500 bg-bg-base text-fg-base">
                </div>

                <!-- Payment Method -->
                <div>
                    <label for="method" class="block text-sm font-medium text-fg-base mb-1">{{ _('Payment Method') }}
                        <span class="text-btn-danger-bg">*</span></label>
                    <select id="method" name="method" required
                        class="w-full px-3 py-2 border border-secondary-200 rounded-lg focus:ring-accent-500 focus:border-accent-500 bg-bg-base text-fg-base">
                        <option value="">{{ _('Select payment method') }}</option>
                        <option value="cash" {% if payment and payment.method=='cash' %}selected{% endif %}>{{ _('Cash')
                            }}</option>
                        <option value="check" {% if payment and payment.method=='check' %}selected{% endif %}>{{
                            _('Check') }}</option>
                        <option value="bank_transfer" {% if payment and payment.method=='bank_transfer' %}selected{%
                            endif %}>{{ _('Bank Transfer') }}</option>
                        <option value="credit_card" {% if payment and payment.method=='credit_card' %}selected{% endif
                            %}>{{ _('Credit Card') }}</option>
                        <option value="other" {% if payment and payment.method=='other' %}selected{% endif %}>{{
                            _('Other') }}</option>
                    </select>
                </div>

                <!-- Notes -->
                <div class="md:col-span-2">
                    <label for="notes" class="block text-sm font-medium text-fg-base mb-1">{{ _('Notes') }}</label>
                    <textarea id="notes" name="notes" rows="3"
                        placeholder="{{ _('Additional notes about this payment...') }}"
                        class="w-full px-3 py-2 border border-secondary-200 rounded-lg focus:ring-accent-500 focus:border-accent-500 bg-bg-base text-fg-base">{{ payment.notes if payment else '' }}</textarea>
                </div>
            </div>

            <div class="flex justify-end space-x-3">
                <a href="{{ url_for('payments.index', company_id=session.get('selected_company_id')) }}"
                    class="px-4 py-2 border border-secondary-200 rounded-lg hover:bg-secondary-100 transition text-fg-base">{{
                    _('Cancel') }}</a>
                <button type="submit"
                    class="bg-btn-primary-bg text-btn-primary-text px-4 py-2 rounded-lg hover:bg-btn-primary-hover transition shadow-sm">
                    {% if payment %}{{ _('Update Payment') }}{% else %}{{ _('Record Payment') }}{% endif %}
                </button>
            </div>
        </form>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const invoiceSearch = document.getElementById('invoice_search');
        const invoiceDropdown = document.getElementById('invoice_dropdown');
        const documentIdInput = document.getElementById('document_id');
        const selectedInvoiceDiv = document.getElementById('selected_invoice');
        const clearInvoiceBtn = document.getElementById('clear_invoice');
        const amountInput = document.getElementById('amount');

        let searchTimeout;

        // Invoice search functionality
        invoiceSearch.addEventListener('input', function () {
            const query = this.value.trim();

            clearTimeout(searchTimeout);

            if (query.length < 2) {
                invoiceDropdown.classList.add('hidden');
                return;
            }

            searchTimeout = setTimeout(() => {
                fetch(`{{ url_for('payments.search_invoices', company_id=session.get('selected_company_id')) }}?q=${encodeURIComponent(query)}`)
                    .then(response => response.json())
                    .then(data => {
                        displaySearchResults(data);
                    })
                    .catch(error => {
                        console.error('Error searching invoices:', error);
                    });
            }, 300);
        });

        function displaySearchResults(invoices) {
            if (invoices.length === 0) {
                invoiceDropdown.innerHTML = '<div class="p-3 text-fg-muted text-sm">{{ _("No invoices found") }}</div>';
            } else {
                invoiceDropdown.innerHTML = invoices.map(invoice => `
                <div class="p-3 hover:bg-secondary-100 cursor-pointer border-b border-secondary-200 last:border-b-0" 
                     data-invoice='${JSON.stringify(invoice)}'>
                    <div class="flex justify-between items-start">
                        <div>
                            <div class="font-medium text-fg-base">${invoice.document_number}</div>
                            <div class="text-sm text-fg-muted">${invoice.client_name || '{{ _("No Client") }}'}</div>
                        </div>
                        <div class="text-right">
                            <div class="text-sm font-medium text-fg-base">L${invoice.remaining_balance.toFixed(2)}</div>
                            <div class="text-xs text-fg-muted">{{ _("Remaining") }}</div>
                        </div>
                    </div>
                    <div class="text-xs text-fg-muted mt-1">
                        {{ _("Total") }}: L${invoice.total_amount.toFixed(2)} | 
                        {{ _("Due") }}: ${invoice.due_date || '{{ _("No due date") }}'}
                    </div>
                </div>
            `).join('');
            }

            invoiceDropdown.classList.remove('hidden');

            // Add click handlers to search results
            invoiceDropdown.querySelectorAll('[data-invoice]').forEach(item => {
                item.addEventListener('click', function () {
                    const invoice = JSON.parse(this.dataset.invoice);
                    selectInvoice(invoice);
                });
            });
        }

        function selectInvoice(invoice) {
            documentIdInput.value = invoice.id;
            invoiceSearch.value = `${invoice.document_number} - ${invoice.client_name || '{{ _("No Client") }}'}`;

            // Update selected invoice display
            document.getElementById('selected_invoice_number').textContent = invoice.document_number;
            document.getElementById('selected_invoice_client').textContent = invoice.client_name || '{{ _("No Client") }}';
            document.getElementById('selected_invoice_total').textContent = `L${invoice.total_amount.toFixed(2)}`;
            document.getElementById('selected_invoice_balance').textContent = `L${invoice.remaining_balance.toFixed(2)}`;

            // Suggest payment amount as remaining balance
            if (!amountInput.value) {
                amountInput.value = invoice.remaining_balance.toFixed(2);
            }

            selectedInvoiceDiv.classList.remove('hidden');
            invoiceDropdown.classList.add('hidden');
        }

        // Clear invoice selection
        clearInvoiceBtn.addEventListener('click', function () {
            documentIdInput.value = '';
            invoiceSearch.value = '';
            selectedInvoiceDiv.classList.add('hidden');
            amountInput.value = '';
        });

        // Hide dropdown when clicking outside
        document.addEventListener('click', function (e) {
            if (!invoiceSearch.contains(e.target) && !invoiceDropdown.contains(e.target)) {
                invoiceDropdown.classList.add('hidden');
            }
        });

        // Set default payment date to today if creating new payment
        {% if not payment %}
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('payment_date').value = today;
        {% endif %}
    });
</script>
{% endblock %}