{% extends "base.html" %}

{% block title %}{{ _('Quote') if invoice.type.value == 'quote' else _('Invoice') }} {{ invoice.document_number }} - {{
_('Business Management System') }}{% endblock %}

{% block content %}
<div class="h-full flex flex-col animate-fadeIn">
    <!-- Header Section -->
    <div class="flex-shrink-0 flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6 gap-4">
        <div>
            <div class="flex items-center gap-3">
                <h2 class="text-2xl font-bold text-slate-100">
                    {% if invoice.type.value == 'quote' %}
                    {{ _('Quote') }} <span class="text-indigo-400">{{ invoice.document_number }}</span>
                    {% else %}
                    {{ _('Invoice') }} <span class="text-indigo-400">{{ invoice.document_number }}</span>
                    {% endif %}
                </h2>
                <span
                    class="px-2.5 py-0.5 rounded-full text-xs font-semibold uppercase tracking-wide {% if invoice.status.value == 'paid' %}bg-emerald-500/20 text-emerald-300 border border-emerald-500/20{% elif invoice.status.value == 'overdue' %}bg-rose-500/20 text-rose-300 border border-rose-500/20{% elif invoice.status.value == 'draft' %}bg-slate-500/20 text-slate-300 border border-slate-500/20{% elif invoice.status.value == 'sent' %}bg-blue-500/20 text-blue-300 border border-blue-500/20{% else %}bg-amber-500/20 text-amber-300 border border-amber-500/20{% endif %}">
                    {{ _(invoice.status.value.title()) if invoice.status else _('Draft') }}
                </span>
            </div>
            <p class="text-slate-400 text-sm mt-1">
                {% if invoice.type.value == 'quote' %}
                {{ _('Quote details and information') }}
                {% else %}
                {{ _('Invoice details and information') }}
                {% endif %}
            </p>
        </div>
        <div class="flex flex-wrap gap-3">
            <a href="{{ url_for('invoices.index', company_id=session.get('selected_company_id')) }}"
                class="bg-slate-700 text-slate-200 hover:bg-slate-600 hover:text-white border border-slate-600 px-4 py-2 rounded-lg transition shadow-sm flex items-center">
                <i class="fas fa-arrow-left mr-2"></i> {{ _('Back') }}
            </a>

            {% if invoice.type.value == 'invoice' and invoice.status != 'paid' %}
            <button onclick="showAddPaymentModal()"
                class="bg-slate-700 text-slate-200 hover:bg-slate-600 hover:text-white border border-slate-600 px-4 py-2 rounded-lg transition shadow-sm flex items-center">
                <i class="fas fa-dollar-sign mr-2 text-emerald-400"></i> {{ _('Add Payment') }}
            </button>
            {% endif %}

            <div class="relative group">
                <button
                    class="bg-slate-700 text-slate-200 hover:bg-slate-600 hover:text-white border border-slate-600 px-4 py-2 rounded-lg transition shadow-sm flex items-center">
                    <i class="fas fa-file-pdf mr-2 text-rose-400"></i> {{ _('PDF') }} <i
                        class="fas fa-chevron-down ml-2 text-xs"></i>
                </button>
                <div
                    class="absolute right-0 pt-2 w-48 invisible group-hover:visible z-20">
                    <div class="bg-slate-800 rounded-lg shadow-lg border border-slate-700 overflow-hidden">
                        <a href="{{ url_for('invoices.print_invoice', company_id=session.get('selected_company_id'), id=invoice.id) }}"
                            target="_blank"
                            class="block px-4 py-2 text-sm text-slate-300 hover:bg-slate-700 hover:text-white first:rounded-t-lg">
                            {{ _('Standard PDF') }}
                        </a>
                        <a href="{{ url_for('invoices.print_invoice', company_id=session.get('selected_company_id'), id=invoice.id, tax=0) }}"
                            target="_blank"
                            class="block px-4 py-2 text-sm text-slate-300 hover:bg-slate-700 hover:text-white last:rounded-b-lg">
                            {{ _('No Tax PDF') }}
                        </a>
                    </div>
                </div>
            </div>

            {% if invoice.type.value == 'quote' %}
            <!-- Convert to Invoice Modal Trigger (Hidden for now as logic might need a refined modal) -->
            <!-- TODO: Implement better convert flow -->
            {% endif %}

            <a href="{{ url_for('invoices.edit', company_id=session.get('selected_company_id'), id=invoice.id) }}"
                class="bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-500 transition shadow-sm flex items-center shadow-indigo-500/20">
                <i class="fas fa-edit mr-2"></i> {{ _('Edit') }}
            </a>
        </div>
    </div>

    <!-- Content Area -->
    <div class="flex-1 overflow-y-auto space-y-8 pb-8">
        <!-- Document Details Card -->
        <div class="bg-slate-800 rounded-xl shadow-lg shadow-black/20 border border-slate-700 overflow-hidden">
            <div class="p-6 md:p-8 grid grid-cols-1 md:grid-cols-2 gap-8">
                <!-- Left: Document Info -->
                <div>
                    <h3 class="text-xs font-semibold text-slate-500 uppercase tracking-wider mb-4">
                        {% if invoice.type.value == 'quote' %}
                        {{ _('Quote Information') }}
                        {% else %}
                        {{ _('Invoice Information') }}
                        {% endif %}
                    </h3>
                    <dl class="grid grid-cols-2 gap-x-4 gap-y-4 text-sm">
                        <div class="col-span-1 text-slate-400">{{ _('Issue Date') }}</div>
                        <div class="col-span-1 font-medium text-slate-200">
                            {% if invoice.issued_date %}
                            {{ invoice.issued_date.strftime('%B %d, %Y') }}
                            {% else %}
                            <span class="text-slate-500">-</span>
                            {% endif %}
                        </div>

                        <div class="col-span-1 text-slate-400">{{ _('Due Date') }}</div>
                        <div class="col-span-1 font-medium text-slate-200">
                            {% if invoice.due_date %}
                            {{ invoice.due_date.strftime('%B %d, %Y') }}
                            {% else %}
                            <span class="text-slate-500">-</span>
                            {% endif %}
                        </div>

                        <div class="col-span-1 text-slate-400">{{ _('Created By') }}</div>
                        <div class="col-span-1 flex items-center gap-2">
                            <div
                                class="h-6 w-6 rounded-full bg-indigo-500/20 flex items-center justify-center text-xs font-bold text-indigo-300">
                                {{ invoice.user.name[0].upper() if invoice.user else 'S' }}
                            </div>
                            <span class="font-medium text-slate-200">{{ invoice.user.name if invoice.user else
                                _('System') }}</span>
                        </div>
                    </dl>
                </div>

                <!-- Right: Client Info -->
                <div>
                    <h3 class="text-xs font-semibold text-slate-500 uppercase tracking-wider mb-4">
                        {{ _('Client Information') }}
                    </h3>
                    {% if invoice.client %}
                    <div class="bg-slate-900/50 rounded-lg p-4 border border-slate-700">
                        <div class="font-bold text-slate-200 mb-1">{{ invoice.client.name }}</div>
                        <div class="text-sm text-slate-400 space-y-1">
                            {% if invoice.client.email %}
                            <div class="flex items-center gap-2">
                                <i class="fas fa-envelope w-4 text-center"></i>
                                <a href="mailto:{{ invoice.client.email }}" class="hover:text-indigo-400 transition">{{
                                    invoice.client.email }}</a>
                            </div>
                            {% endif %}
                            {% if invoice.client.phone %}
                            <div class="flex items-center gap-2">
                                <i class="fas fa-phone w-4 text-center"></i>
                                <span>{{ invoice.client.phone }}</span>
                            </div>
                            {% endif %}
                            {% if invoice.client.address %}
                            <div class="flex items-start gap-2 max-w-xs">
                                <i class="fas fa-map-marker-alt w-4 text-center mt-1"></i>
                                <span>{{ invoice.client.address }}</span>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                    {% else %}
                    <div class="bg-slate-900/50 rounded-lg p-4 border border-slate-700 text-slate-400 italic text-sm">
                        {{ _('No client associated with this document.') }}
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- Items Table -->
            <div class="border-t border-slate-700">
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-slate-700">
                        <thead class="bg-slate-900/50">
                            <tr>
                                <th scope="col"
                                    class="px-6 py-3 text-left text-xs font-semibold text-slate-400 uppercase tracking-wider">
                                    {{ _('Item & Description') }}
                                </th>
                                <th scope="col"
                                    class="px-6 py-3 text-right text-xs font-semibold text-slate-400 uppercase tracking-wider w-24">
                                    {{ _('Qty') }}
                                </th>
                                <th scope="col"
                                    class="px-6 py-3 text-right text-xs font-semibold text-slate-400 uppercase tracking-wider w-32">
                                    {{ _('Unit Price') }}
                                </th>
                                <th scope="col"
                                    class="px-6 py-3 text-right text-xs font-semibold text-slate-400 uppercase tracking-wider w-24">
                                    {{ _('Disc.') }}
                                </th>
                                <th scope="col"
                                    class="px-6 py-3 text-right text-xs font-semibold text-slate-400 uppercase tracking-wider w-32">
                                    {{ _('Total') }}
                                </th>
                            </tr>
                        </thead>
                        <tbody class="bg-slate-800 divide-y divide-slate-700">
                            {% for item in document_items %}
                            <tr>
                                <td class="px-6 py-4">
                                    <div class="text-sm font-medium text-slate-200">
                                        {{ item.inventory_item.name if item.inventory_item else _('Custom Item') }}
                                    </div>
                                    {% if item.description %}
                                    <div class="text-sm text-slate-400 mt-0.5">{{ item.description }}</div>
                                    {% endif %}
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap text-right text-sm text-slate-400">
                                    {{ item.quantity }}
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap text-right text-sm text-slate-400">
                                    {{ session.get('currency') }}{{ "{:,.2f}".format(item.unit_price) }}
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap text-right text-sm text-slate-400">
                                    {% if item.discount > 0 %}
                                    <span class="text-rose-400">-{{ session.get('currency') }}{{
                                        "{:,.2f}".format(item.discount) }}</span>
                                    {% else %}
                                    -
                                    {% endif %}
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium text-slate-200">
                                    {{ session.get('currency') }}{{ "{:,.2f}".format((item.quantity * item.unit_price) -
                                    (item.discount or 0)) }}
                                </td>
                            </tr>
                            {% else %}
                            <tr>
                                <td colspan="5" class="px-6 py-12 text-center text-slate-500 italic">
                                    {{ _('No items added to this document.') }}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
            <!-- Summary Section -->
            <div class="bg-slate-900/50 border-t border-slate-700 px-6 py-6 sm:px-8">
                <div class="flex flex-col lg:flex-row justify-between gap-8">
                    <!-- Notes -->
                    <div class="w-full lg:w-1/2">
                        <h4 class="text-xs font-semibold text-slate-500 uppercase tracking-wider mb-3">{{ _('Notes') }}</h4>
                        <div class="text-sm text-slate-400 whitespace-pre-line bg-slate-900 rounded-lg p-4 border border-slate-700">
                            {{ invoice.notes or _('No notes provided.') }}
                        </div>
                    </div>
                    <!-- Summary Totals -->
                    <div class="w-full lg:w-1/3 space-y-3">
                        <div class="flex justify-between text-sm text-slate-400">
                            <span>{{ _('Subtotal') }}</span>
                            <span class="font-medium text-slate-200">{{ session.get('currency') }}{{ "{:,.2f}".format(invoice.subtotal) }}</span>
                        </div>
                        <div class="flex justify-between text-sm text-slate-400">
                            <span>{{ _('Tax') }} (15%)</span>
                            <span class="font-medium text-slate-200">{{ session.get('currency') }}{{ "{:,.2f}".format(invoice.tax_amount) }}</span>
                        </div>
                        <div class="flex justify-between text-base font-bold text-slate-100 pt-3 border-t border-slate-700">
                            <span>{{ _('Total') }}</span>
                            <span class="text-indigo-400">{{ session.get('currency') }}{{ "{:,.2f}".format(invoice.total_amount) }}</span>
                        </div>
                        {% if invoice.type.value == 'invoice' %}
                        <div class="flex justify-between text-sm pt-2 text-slate-400">
                            <span>{{ _('Amount Paid') }}</span>
                            <span class="font-medium text-emerald-400">{{ session.get('currency') }}{{ "{:,.2f}".format(invoice.calculate_paid_amount()) }}</span>
                        </div>
                        <div class="flex justify-between text-sm font-semibold text-slate-300">
                            <span>{{ _('Balance Due') }}</span>
                            <span class="{{ 'text-rose-400' if invoice.calculate_balance_due() > 0 else 'text-slate-400' }}">
                                {{ session.get('currency') }}{{ "{:,.2f}".format(invoice.calculate_balance_due()) }}
                            </span>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- Payments Section (Only for Invoices) -->
            {% if invoice.type.value == 'invoice' %}
            <div class="mt-8">
                <h3 class="text-lg font-bold text-slate-100 mb-4 flex items-center">
                    {{ _('Payment History') }}
                </h3>
                {% if invoice.payments %}
                <div
                    class="bg-slate-800 rounded-xl shadow-lg shadow-black/20 border border-slate-700 overflow-hidden">
                    <table class="min-w-full divide-y divide-slate-700">
                        <thead class="bg-slate-900/50">
                            <tr>
                                <th scope="col"
                                    class="px-6 py-3 text-left text-xs font-semibold text-slate-400 uppercase tracking-wider">
                                    {{ _('Date') }}
                                </th>
                                <th scope="col"
                                    class="px-6 py-3 text-left text-xs font-semibold text-slate-400 uppercase tracking-wider">
                                    {{ _('Notes') }}
                                </th>
                                <th scope="col"
                                    class="px-6 py-3 text-left text-xs font-semibold text-slate-400 uppercase tracking-wider">
                                    {{ _('Method') }}
                                </th>
                                <th scope="col"
                                    class="px-6 py-3 text-right text-xs font-semibold text-slate-400 uppercase tracking-wider">
                                    {{ _('Amount') }}
                                </th>
                                <th scope="col"
                                    class="px-6 py-3 text-right text-xs font-semibold text-slate-400 uppercase tracking-wider">
                                    {{ _('Status') }}
                                </th>
                            </tr>
                        </thead>
                        <tbody class="bg-slate-800 divide-y divide-slate-700">
                            {% for payment in invoice.payments %}
                            <tr>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-400">
                                    {{ payment.payment_date.strftime('%Y-%m-%d') }}
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-200 font-medium">
                                    {{ payment.notes or '-' }}
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-400">
                                    {{ payment.method.value.title() if payment.method else '-' }}
                                </td>
                                <td
                                    class="px-6 py-4 whitespace-nowrap text-sm text-right font-medium text-emerald-400">
                                    {{ session.get('currency') }}{{ "{:,.2f}".format(payment.amount) }}
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                                    <span class="text-slate-400 text-xs uppercase tracking-wider">{{ _('Recorded') }}</span>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="bg-slate-800 rounded-xl p-8 text-center border border-slate-700 border-dashed">
                    <div
                        class="inline-flex items-center justify-center w-12 h-12 rounded-full bg-slate-700 mb-4 text-slate-400">
                        <i class="fas fa-receipt text-lg"></i>
                    </div>
                    <h3 class="mt-2 text-sm font-medium text-slate-200">{{ _('No payments recorded') }}</h3>
                    <p class="mt-1 text-sm text-slate-500">{{ _('Record a payment to mark this invoice as paid.') }}
                    </p>
                    <div class="mt-6">
                        <button onclick="showAddPaymentModal()"
                            class="inline-flex items-center px-4 py-2 border border-transparent shadow-sm text-sm font-medium rounded-lg text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition-colors shadow-indigo-500/20">
                            <i class="fas fa-plus mr-2"></i> {{ _('Add Payment') }}
                        </button>
                    </div>
                </div>
                    {% endif %}
                </div>
                {% endif %}

                <!-- Footer -->
                <div class="mt-8 border-t border-slate-700 pt-8 text-center text-sm text-slate-500">
                    <p>&copy; {{ now.year if now else '2025' }} {{ _('StartUp POS') }}. {{ _('All rights reserved.') }}
                    </p>
                </div>
            </div>

            <!-- Add Payment Modal -->
            {% if invoice.type.value == 'invoice' %}
            <div id="addPaymentModal" class="fixed inset-0 z-50 hidden" aria-labelledby="modal-title" role="dialog"
                aria-modal="true">
                <div class="flex items-end justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
                    <div class="fixed inset-0 bg-slate-900/80 backdrop-blur-sm transition-opacity z-40" aria-hidden="true"
                        onclick="hideAddPaymentModal()"></div>

                    <span class="hidden sm:inline-block sm:align-middle sm:h-screen" aria-hidden="true">&#8203;</span>

                    <div
                        class="relative z-50 inline-block align-bottom bg-slate-800 rounded-xl text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full border border-slate-700">
                        <div class="bg-slate-800 px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
                            <div class="sm:flex sm:items-start">
                                <div
                                    class="mx-auto flex-shrink-0 flex items-center justify-center h-12 w-12 rounded-full bg-emerald-500/20 sm:mx-0 sm:h-10 sm:w-10 text-emerald-400">
                                    <i class="fas fa-dollar-sign"></i>
                                </div>
                                <div class="mt-3 text-center sm:mt-0 sm:ml-4 sm:text-left w-full">
                                    <h3 class="text-lg leading-6 font-medium text-slate-100" id="modal-title">
                                        {{ _('Record Payment') }}
                                    </h3>
                                    <div class="mt-4">
                                        <form id="paymentForm"
                                            action="{{ url_for('invoices.add_payment', company_id=session.get('selected_company_id'), id=invoice.id) }}"
                                            method="POST">
                                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

                                            <div class="grid grid-cols-1 gap-y-4">
                                                <div>
                                                    <label for="amount"
                                                        class="block text-sm font-medium text-slate-400">
                                                        {{ _('Amount') }}
                                                    </label>
                                                    <div class="mt-1 relative rounded-md shadow-sm">
                                                        <div
                                                            class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                                            <span class="text-slate-500 sm:text-sm">{{
                                                                session.get('currency')
                                                                }}</span>
                                                        </div>
                                                        <input type="number" name="amount" id="amount"
                                                            class="focus:ring-indigo-500 focus:border-indigo-500 block w-full pl-7 pr-12 sm:text-sm border-slate-600 rounded-lg bg-slate-700 text-white placeholder-slate-400"
                                                            placeholder="0.00" step="0.01" min="0.01"
                                                            max="{{ invoice.calculate_balance_due() }}" required
                                                            value="{{ invoice.calculate_balance_due() }}">
                                                    </div>
                                                </div>

                                                <div>
                                                    <label for="payment_date"
                                                        class="block text-sm font-medium text-slate-400">
                                                        {{ _('Payment Date') }}
                                                    </label>
                                                    <div class="mt-1">
                                                        <input type="date" name="payment_date" id="payment_date"
                                                            class="shadow-sm focus:ring-indigo-500 focus:border-indigo-500 block w-full sm:text-sm border-slate-600 rounded-lg bg-slate-700 text-white [color-scheme:dark]"
                                                            required
                                                            value="{{ now.strftime('%Y-%m-%d') if now else '' }}">
                                                    </div>
                                                </div>

                                                <div>
                                                    <label for="payment_method"
                                                        class="block text-sm font-medium text-slate-400">
                                                        {{ _('Payment Method') }}
                                                    </label>
                                                    <div class="mt-1">
                                                        <select id="payment_method" name="payment_method"
                                                            class="shadow-sm focus:ring-indigo-500 focus:border-indigo-500 block w-full sm:text-sm border-slate-600 rounded-lg bg-slate-700 text-white">
                                                            <option value="cash">{{ _('Cash') }}</option>
                                                            <option value="bank_transfer">{{ _('Bank Transfer') }}
                                                            </option>
                                                            <option value="credit_card">{{ _('Credit Card') }}</option>
                                                            <option value="check">{{ _('Check') }}</option>
                                                            <option value="other">{{ _('Other') }}</option>
                                                        </select>
                                                    </div>
                                                </div>

                                                <div>
                                                    <label for="reference"
                                                        class="block text-sm font-medium text-slate-400">
                                                        {{ _('Reference / Note') }}
                                                    </label>
                                                    <div class="mt-1">
                                                        <input type="text" name="reference" id="reference"
                                                            class="shadow-sm focus:ring-indigo-500 focus:border-indigo-500 block w-full sm:text-sm border-slate-600 rounded-lg bg-slate-700 text-white placeholder-slate-400"
                                                            placeholder="{{ _('Optional transaction ID or note') }}">
                                                    </div>
                                                </div>
                                            </div>

                                            <div
                                                class="mt-5 sm:mt-6 sm:grid sm:grid-cols-2 sm:gap-3 sm:grid-flow-row-dense">
                                                <button type="submit"
                                                    class="w-full inline-flex justify-center rounded-lg border border-transparent shadow-sm px-4 py-2 bg-indigo-600 text-base font-medium text-white hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 sm:col-start-2 sm:text-sm shadow-indigo-500/20">
                                                    {{ _('Record Payment') }}
                                                </button>
                                                <button type="button" onclick="hideAddPaymentModal()"
                                                    class="mt-3 w-full inline-flex justify-center rounded-lg border border-slate-600 shadow-sm px-4 py-2 bg-slate-700 text-base font-medium text-slate-200 hover:bg-slate-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 sm:mt-0 sm:col-start-1 sm:text-sm">
                                                    {{ _('Cancel') }}
                                                </button>
                                            </div>
                                        </form>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            {% endif %}
        </div>
    </div>

    <script>
        // Set default date for payment modal
        document.addEventListener('DOMContentLoaded', function () {
            const dateInput = document.getElementById('payment_date');
            if (dateInput) {
                dateInput.valueAsDate = new Date();
            }
        });

        function showAddPaymentModal() {
            document.getElementById('addPaymentModal').classList.remove('hidden');
        }

        function hideAddPaymentModal() {
            document.getElementById('addPaymentModal').classList.add('hidden');
        }
    </script>
</div>
{% endblock %}