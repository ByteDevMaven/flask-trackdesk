{% extends "base.html" %}

{% block title %}{{ item.name }} - {{ _('Inventory Item') }} - {{ _('Business Management System') }}{% endblock %}

{% block content %}
<!-- Header -->
<div class="mb-8">
    <div class="flex items-center justify-between">
        <div class="flex items-center space-x-4">
            <a href="{{ url_for('inventory.index', company_id=company_id) }}"
                class="w-10 h-10 flex items-center justify-center rounded-xl bg-slate-800 text-slate-400 hover:text-white transition-all border border-slate-700 hover:bg-slate-700 shadow-md">
                <i class="fas fa-arrow-left"></i>
            </a>
            <div>
                <h2 class="text-3xl font-extrabold text-white tracking-tight">{{ item.name }}</h2>
                <p class="text-slate-400 text-sm mt-1 font-medium">{{ _('Inventory Item Details') }}</p>
            </div>
        </div>
        <div class="flex space-x-3">
            <a href="{{ url_for('inventory.edit', company_id=company_id, id=item.id) }}"
                class="bg-slate-800 text-slate-200 px-4 py-2.5 rounded-xl hover:bg-slate-700 transition-all border border-slate-700 font-bold flex items-center text-sm shadow-lg shadow-black/20">
                <i class="fas fa-edit mr-2 text-amber-500"></i>{{ _('Edit') }}
            </a>
            <form action="{{ url_for('inventory.delete', company_id=company_id, id=item.id) }}" method="POST"
                class="inline">
                <input type="hidden" id="csrf_token" name="csrf_token" value="{{ csrf_token() }}">
                <button type="submit"
                    class="bg-rose-600/10 text-rose-400 px-4 py-2.5 rounded-xl hover:bg-rose-600 hover:text-white transition-all border border-rose-500/20 font-bold flex items-center text-sm shadow-lg shadow-rose-500/10"
                    onclick="return confirm('{{ _('Are you sure you want to delete this item?') }}')">
                    <i class="fas fa-trash mr-2"></i>{{ _('Delete') }}
                </button>
            </form>
        </div>
    </div>
</div>

<div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
    <!-- Main Details -->
    <div class="lg:col-span-2 space-y-8">
        <!-- Item Information -->
        <div class="bg-slate-800 rounded-2xl shadow-xl border border-slate-700 p-8 shadow-black/20">
            <h3 class="text-lg font-bold text-white mb-8 flex items-center">
                <i class="fas fa-info-circle mr-2 text-indigo-400"></i>
                {{ _('Item Information') }}
            </h3>

            <div class="grid grid-cols-1 gap-8">
                <div>
                    <label class="block text-xs font-bold text-slate-500 uppercase tracking-widest mb-2">{{ _('Name')
                        }}</label>
                    <p class="text-xl font-bold text-white">{{ item.name }}</p>
                </div>

                {% if item.description %}
                <div>
                    <label class="block text-xs font-bold text-slate-500 uppercase tracking-widest mb-2">{{
                        _('Description') }}</label>
                    <div class="bg-slate-900/50 rounded-xl p-4 border border-slate-700/50">
                        <p class="text-slate-300 leading-relaxed font-medium text-sm">{{ item.description }}</p>
                    </div>
                </div>
                {% endif %}

                <div class="grid grid-cols-1 md:grid-cols-2 gap-8 pt-4">
                    <div class="bg-slate-900/40 p-4 rounded-xl border border-slate-700/30">
                        <label class="block text-xs font-bold text-slate-500 uppercase tracking-widest mb-2">{{
                            _('Current Quantity')
                            }}</label>
                        <div class="flex items-center space-x-3">
                            <span class="text-3xl font-extrabold text-white">{{ item.quantity }}</span>
                            <span class="px-3 py-1 text-[10px] rounded-full font-bold border uppercase tracking-widest
                                    {% if item.quantity == 0 %}bg-rose-500/10 text-rose-400 border-rose-500/20
                                    {% elif item.quantity <= 10 %}bg-amber-500/10 text-amber-500 border-amber-500/20
                                    {% else %}bg-indigo-500/10 text-indigo-400 border-indigo-500/20{% endif %}">
                                {% if item.quantity == 0 %}{{ _('Out of Stock') }}
                                {% elif item.quantity <= 10 %}{{ _('Low Stock') }} {% else %}{{ _('In Stock') }}{% endif
                                    %} </span>
                        </div>
                    </div>

                    <div class="bg-slate-900/40 p-4 rounded-xl border border-slate-700/30">
                        <label class="block text-xs font-bold text-slate-500 uppercase tracking-widest mb-2">{{ _('Unit
                            Price') }}</label>
                        <p class="text-3xl font-extrabold text-white">{{ session.get('currency') }}{{
                            "{:,.2f}".format(item.price) }}</p>
                    </div>
                </div>

                {% if item.supplier %}
                <div class="pt-4 border-t border-slate-700/50">
                    <label class="block text-xs font-bold text-slate-500 uppercase tracking-widest mb-2">{{
                        _('Supplier') }}</label>
                    <div class="flex items-center text-indigo-400 font-bold">
                        <i class="fas fa-truck-field mr-2 text-sm"></i>
                        <span class="text-lg">{{ item.supplier.name }}</span>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- Barcode Section -->
        <div class="bg-slate-800 rounded-2xl shadow-xl border border-slate-700 p-8 shadow-black/20">
            <h3 class="text-lg font-bold text-white mb-8 flex items-center">
                <i class="fas fa-barcode mr-2 text-indigo-400"></i>
                {{ _('Barcode Information') }}
            </h3>

            <div class="space-y-6">
                <div class="flex items-center justify-between flex-wrap gap-4">
                    <div>
                        <p class="text-xs font-bold text-slate-500 uppercase tracking-widest mb-1">{{ _('Item Code') }}
                        </p>
                        <p
                            class="text-xl font-mono font-bold text-white tracking-wider bg-slate-900 px-4 py-1.5 rounded-lg border border-slate-700 inline-block">
                            {{ company_id }}{{ "%06d"|format(item.id) }}</p>
                    </div>
                    <div class="flex space-x-3">
                        <button type="button" onclick="viewBarcode()"
                            class="bg-slate-700 text-slate-200 px-5 py-2.5 rounded-xl hover:bg-slate-600 transition-all font-bold flex items-center text-sm border border-slate-600">
                            <i class="fas fa-eye mr-2 text-indigo-400"></i>{{ _('Show Barcode') }}
                        </button>
                        <a href="{{ url_for('inventory.download_barcode', company_id=company_id, id=item.id) }}"
                            class="bg-indigo-600 text-white px-5 py-2.5 rounded-xl hover:bg-indigo-500 transition-all font-bold flex items-center text-sm shadow-lg shadow-indigo-500/20">
                            <i class="fas fa-download mr-2"></i>{{ _('Download') }}
                        </a>
                    </div>
                </div>

                <!-- Barcode Display Area -->
                <div id="barcode-container" class="hidden animate-fadeIn">
                    <div class="bg-white border border-slate-200 rounded-2xl p-8 text-center shadow-inner">
                        <img id="barcode-image" src="/placeholder.svg" alt="{{ _('Barcode') }}"
                            class="mx-auto max-w-full h-auto">
                        <p class="text-xs font-bold text-slate-400 mt-4 uppercase tracking-widest">{{ _('Dynamic Barcode
                            Generator') }}</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Sidebar -->
    <div class="space-y-8">
        <!-- Stock Management -->
        <div class="bg-slate-800 rounded-2xl shadow-xl border border-slate-700 p-8 shadow-black/20">
            <h3 class="text-lg font-bold text-white mb-8 flex items-center">
                <i class="fas fa-bolt mr-2 text-indigo-400"></i>
                {{ _('Quick Actions') }}
            </h3>

            <div class="space-y-6">
                <div
                    class="flex items-center justify-between bg-slate-900/40 p-4 rounded-xl border border-slate-700/30">
                    <span class="text-xs font-bold text-slate-500 uppercase tracking-widest">{{ _('Stock Value')
                        }}</span>
                    <span class="font-bold text-white text-lg">{{ session.get('currency') }}{{
                        "{:,.2f}".format(item.quantity * item.price) }}</span>
                </div>

                <div class="flex space-x-3">
                    <button type="button"
                        class="stock-adjust-btn flex-1 bg-rose-600/10 text-rose-400 px-4 py-3 rounded-xl hover:bg-rose-600 hover:text-white transition-all border border-rose-500/20 font-bold text-sm"
                        data-item-id="{{ item.id }}" data-adjustment="-1">
                        <i class="fas fa-minus mr-2"></i>{{ _('Remove 1') }}
                    </button>
                    <button type="button"
                        class="stock-adjust-btn flex-1 bg-indigo-600/10 text-indigo-400 px-4 py-3 rounded-xl hover:bg-indigo-600 hover:text-white transition-all border border-indigo-500/20 font-bold text-sm"
                        data-item-id="{{ item.id }}" data-adjustment="1">
                        <i class="fas fa-plus mr-2"></i>{{ _('Add 1') }}
                    </button>
                </div>

                <button type="button"
                    class="w-full bg-slate-700 text-slate-200 px-4 py-3 rounded-xl hover:bg-indigo-600 hover:text-white transition-all font-bold text-sm border border-slate-600"
                    onclick="showStockAdjustModal()">
                    <i class="fas fa-sliders mr-2 text-indigo-400"></i>{{ _('Custom Adjustment') }}
                </button>
            </div>
        </div>

        <!-- Item Status -->
        <div class="bg-indigo-500/10 rounded-2xl border border-indigo-500/20 p-8">
            <h3 class="text-lg font-bold text-white mb-6 flex items-center">
                <i class="fas fa-signal mr-2 text-indigo-400"></i>
                {{ _('Inventory Health') }}
            </h3>

            <div class="space-y-4">
                <div
                    class="flex justify-between items-center bg-slate-900/40 p-3 rounded-xl border border-slate-700/30">
                    <span class="text-xs font-bold text-slate-400 uppercase tracking-widest">{{ _('Stock Level')
                        }}</span>
                    <span class="px-3 py-1 text-[10px] rounded-full font-bold border uppercase tracking-widest
                            {% if item.quantity == 0 %}bg-rose-500/10 text-rose-400 border-rose-500/20
                            {% elif item.quantity <= 10 %}bg-amber-500/10 text-amber-500 border-amber-500/20
                            {% else %}bg-emerald-500/10 text-emerald-400 border-emerald-500/20{% endif %}">
                        {% if item.quantity == 0 %}{{ _('Critical') }}
                        {% elif item.quantity <= 10 %}{{ _('Low') }} {% else %}{{ _('Good') }}{% endif %} </span>
                </div>

                <div
                    class="flex justify-between items-center bg-slate-900/40 p-3 rounded-xl border border-slate-700/30">
                    <span class="text-xs font-bold text-slate-400 uppercase tracking-widest">{{ _('Portfolio Tier')
                        }}</span>
                    <span class="text-xs font-bold text-white uppercase tracking-widest">
                        {% if item.quantity * item.price > 1000 %}{{ _('High Value') }}
                        {% elif item.quantity * item.price > 100 %}{{ _('Medium Value') }}
                        {% else %}{{ _('Low Value') }}{% endif %}
                    </span>
                </div>
            </div>
        </div>

        <!-- Barcode Actions -->
        <div class="bg-slate-800 rounded-2xl shadow-xl border border-slate-700 p-8 shadow-black/20">
            <h3 class="text-lg font-bold text-white mb-8 flex items-center">
                <i class="fas fa-print mr-2 text-indigo-400"></i>
                {{ _('Print Options') }}
            </h3>

            <div class="space-y-3">
                <button type="button" onclick="viewBarcode()"
                    class="w-full bg-slate-700 text-slate-300 px-4 py-3 rounded-xl hover:bg-slate-600 transition-all font-bold flex items-center justify-center text-sm border border-slate-600">
                    <i class="fas fa-barcode mr-2 text-indigo-400"></i>{{ _('Preview Barcode') }}
                </button>

                <a href="{{ url_for('inventory.download_barcode', company_id=company_id, id=item.id) }}"
                    class="w-full bg-slate-700 text-slate-300 px-4 py-3 rounded-xl hover:bg-slate-600 transition-all font-bold flex items-center justify-center text-sm border border-slate-600">
                    <i class="fas fa-image mr-2 text-emerald-400"></i>{{ _('Download PNG') }}
                </a>

                <button type="button" onclick="printBarcode()"
                    class="w-full bg-indigo-600 text-white px-4 py-3 rounded-xl hover:bg-indigo-500 transition-all font-bold flex items-center justify-center text-sm shadow-lg shadow-indigo-500/20">
                    <i class="fas fa-print mr-2"></i>{{ _('Print Label') }}
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Stock Adjustment Modal -->
<div id="stockAdjustModal"
    class="fixed inset-0 bg-slate-900/80 backdrop-blur-sm hidden items-center justify-center z-50">
    <div
        class="bg-slate-800 rounded-2xl shadow-2xl max-w-md w-full mx-4 border border-slate-700 animate-fadeInShort shadow-black/50">
        <div class="p-8">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-bold text-white">{{ _('Adjust Stock Level') }}</h3>
                <button type="button" onclick="hideStockAdjustModal()"
                    class="w-8 h-8 flex items-center justify-center rounded-lg bg-slate-700 text-slate-400 hover:text-white transition-all">
                    <i class="fas fa-times"></i>
                </button>
            </div>

            <form id="stock-adjust-form">
                <div class="mb-6">
                    <label for="adjustment" class="block text-sm font-bold text-slate-300 mb-2">{{ _('Adjustment
                        Amount') }}</label>
                    <input type="number" id="adjustment" name="adjustment"
                        class="w-full px-4 py-3 bg-slate-900 border border-slate-700 rounded-xl text-white placeholder-slate-500
                               focus:ring-2 focus:ring-indigo-500/20 focus:border-indigo-500 focus:outline-none transition-all" placeholder="{{ _('e.g. 5 or -5') }}">
                    <p class="text-xs text-slate-500 mt-2 font-medium">{{ _('Use positive numbers to add stock, negative
                        to remove')
                        }}</p>
                </div>

                <div class="flex justify-end space-x-3">
                    <button type="button" onclick="hideStockAdjustModal()"
                        class="px-6 py-2.5 bg-slate-700 text-slate-300 rounded-xl hover:bg-slate-600 transition-all font-bold text-sm">
                        {{ _('Cancel') }}
                    </button>
                    <button type="submit"
                        class="px-6 py-2.5 bg-indigo-600 text-white rounded-xl hover:bg-indigo-500 transition-all shadow-lg shadow-indigo-500/20 font-bold text-sm">
                        {{ _('Confirm Adjustment') }}
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Barcode Print Modal -->
<div id="barcodePrintModal"
    class="fixed inset-0 bg-slate-900/80 backdrop-blur-sm hidden items-center justify-center z-50">
    <div
        class="bg-slate-800 rounded-2xl shadow-2xl max-w-lg w-full mx-4 border border-slate-700 animate-fadeInShort shadow-black/50">
        <div class="p-8">
            <div class="flex justify-between items-center mb-8">
                <h3 class="text-xl font-bold text-white">{{ _('Barcode Label Preview') }}</h3>
                <button type="button" onclick="hideBarcodeModal()"
                    class="w-8 h-8 flex items-center justify-center rounded-lg bg-slate-700 text-slate-400 hover:text-white transition-all">
                    <i class="fas fa-times"></i>
                </button>
            </div>

            <div class="text-center mb-10 bg-white p-8 rounded-2xl shadow-inner border border-slate-200">
                <img id="print-barcode-image" src="/placeholder.svg" alt="{{ _('Barcode') }}"
                    class="mx-auto max-w-full h-auto">
                <div class="mt-6 space-y-2">
                    <p class="text-lg font-bold text-slate-900">{{ item.name }}</p>
                    <p
                        class="text-sm font-mono text-slate-500 bg-slate-50 px-3 py-1 rounded-lg inline-block border border-slate-100">
                        {{ _('Code: ') }}{{ company_id }}{{ "%06d"|format(item.id) }}</p>
                    <p class="text-xl font-extrabold text-indigo-600 block">{{ session.get('currency') }}{{
                        "{:,.2f}".format(item.price) }}</p>
                </div>
            </div>

            <div class="flex justify-end space-x-3">
                <button type="button" onclick="hideBarcodeModal()"
                    class="px-6 py-2.5 bg-slate-700 text-slate-300 rounded-xl hover:bg-slate-600 transition-all font-bold text-sm">
                    {{ _('Cancel') }}
                </button>
                <button type="button" onclick="window.print()"
                    class="px-6 py-2.5 bg-indigo-600 text-white rounded-xl hover:bg-indigo-500 transition-all shadow-lg shadow-indigo-500/20 font-bold text-sm">
                    <i class="fas fa-print mr-2"></i>{{ _('Print Now') }}
                </button>
            </div>
        </div>
    </div>
</div>

<script>
    const pathParts = window.location.pathname.split('/');
    const companyId = pathParts[1];
    const itemId = pathParts[3];
    const csrf_token = document.getElementById('csrf_token').value;

    document.addEventListener('DOMContentLoaded', function () {
        // Stock adjustment functionality
        document.querySelectorAll('.stock-adjust-btn').forEach(button => {
            button.addEventListener('click', function () {
                const adjustment = parseInt(this.dataset.adjustment);
                adjustStock(adjustment);
            });
        });

        // Custom stock adjustment form
        document.getElementById('stock-adjust-form').addEventListener('submit', function (e) {
            e.preventDefault();
            const adjustment = parseInt(document.getElementById('adjustment').value);
            if (!isNaN(adjustment)) {
                adjustStock(adjustment);
                hideStockAdjustModal();
            }
        });

        function adjustStock(adjustment) {
            fetch(`/api/${companyId}/inventory/items/${itemId}/adjust-stock`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrf_token
                },
                body: JSON.stringify({ adjustment: adjustment })
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        location.reload(); // Reload to show updated values
                    } else {
                        alert(data.error || '{{ _("An error occurred") }}');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('{{ _("An error occurred") }}');
                });
        }
    });

    function showStockAdjustModal() {
        const modal = document.getElementById('stockAdjustModal');
        modal.classList.remove('hidden');
        modal.classList.add('flex');
        document.getElementById('adjustment').focus();
    }

    function hideStockAdjustModal() {
        const modal = document.getElementById('stockAdjustModal');
        modal.classList.add('hidden');
        modal.classList.remove('flex');
        document.getElementById('adjustment').value = '';
    }

    function viewBarcode() {
        const barcodeContainer = document.getElementById('barcode-container');
        const barcodeImage = document.getElementById('barcode-image');

        // Show loading state
        barcodeImage.src = '';
        barcodeContainer.classList.remove('hidden');

        // Load barcode image
        barcodeImage.src = `/${companyId}/inventory/${itemId}/barcode`;
        barcodeImage.onload = function () {
            // Scroll to barcode
            barcodeContainer.scrollIntoView({ behavior: 'smooth', block: 'center' });
        };
    }

    function printBarcode() {
        const modal = document.getElementById('barcodePrintModal');
        const printImage = document.getElementById('print-barcode-image');

        // Load barcode image
        printImage.src = `/${companyId}/inventory/${itemId}/barcode`;

        // Show modal
        modal.classList.remove('hidden');
        modal.classList.add('flex');
    }

    function hideBarcodeModal() {
        const modal = document.getElementById('barcodePrintModal');
        modal.classList.add('hidden');
        modal.classList.remove('flex');
    }

    // Print styles for barcode modal
    const printStyles = `
    @media print {
        body * {
            visibility: hidden;
        }
        #barcodePrintModal, #barcodePrintModal * {
            visibility: visible;
        }
        #barcodePrintModal {
            position: absolute;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: white !important;
            padding: 0;
            margin: 0;
        }
        #barcodePrintModal .p-8 {
            padding: 2rem !important;
        }
        #barcodePrintModal .flex.justify-between, 
        #barcodePrintModal .flex.justify-end {
            display: none !important;
        }
        #barcodePrintModal .bg-white {
            box-shadow: none !important;
            border: none !important;
        }
    }
`;

    // Add print styles to head
    const styleSheet = document.createElement('style');
    styleSheet.textContent = printStyles;
    document.head.appendChild(styleSheet);
</script>
{% endblock %}