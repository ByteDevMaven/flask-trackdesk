{% extends "base.html" %}

{% block title %}{% if user %}{{ _('Edit User') }}{% else %}{{ _('New User') }}{% endif %} - {{ _('Business Management System') }}{% endblock %}

{% block content %}
<div class="animate-fadeIn">
    <div class="flex justify-between items-center mb-6">
        <div>
            <h2 class="text-2xl font-bold text-fg-base">{% if user %}{{ _('Edit User') }}{% else %}{{ _('New User') }}{%
                endif %}</h2>
            <p class="text-fg-muted text-sm mt-1">{% if user %}{{ _('Update user information and permissions') }}{% else
                %}{{ _('Create a new system user') }}{% endif %}</p>
        </div>
        <div>
            <a href="{{ url_for('users.index') }}"
                class="bg-btn-secondary-bg text-btn-secondary-text px-4 py-2 rounded-lg hover:bg-btn-secondary-hover transition flex items-center">
                <i class="fas fa-arrow-left mr-2"></i> {{ _('Back to Users') }}
            </a>
        </div>
    </div>

    <!-- User Form -->
    <div class="bg-bg-subtle rounded-xl shadow-sm p-6 border border-secondary-200">
        <form
            action="{% if user %}{{ url_for('users.update', id=user.id) }}{% else %}{{ url_for('users.store') }}{% endif %}"
            method="POST">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                <!-- Name -->
                <div>
                    <label for="name" class="block text-sm font-medium text-fg-base mb-1">{{ _('Full Name') }} <span
                            class="text-btn-danger-bg">*</span></label>
                    <input type="text" id="name" name="name" value="{{ user.name if user else '' }}" required
                        class="w-full px-3 py-2 border border-secondary-200 rounded-lg focus:ring-accent-500 focus:border-accent-500 bg-bg-base"
                        placeholder="{{ _('Enter full name') }}">
                </div>

                <!-- Email -->
                <div>
                    <label for="email" class="block text-sm font-medium text-fg-base mb-1">{{ _('Email Address') }}
                        <span class="text-btn-danger-bg">*</span></label>
                    <input type="email" id="email" name="email" value="{{ user.email if user else '' }}" required
                        class="w-full px-3 py-2 border border-secondary-200 rounded-lg focus:ring-accent-500 focus:border-accent-500 bg-bg-base"
                        placeholder="{{ _('Enter email address') }}">
                </div>

                <!-- Password -->
                <div>
                    <label for="password" class="block text-sm font-medium text-fg-base mb-1">
                        {{ _('Password') }}
                        {% if not user %}<span class="text-btn-danger-bg">*</span>{% endif %}
                        {% if user %}<span class="text-fg-muted text-xs">({{ _('Leave blank to keep current password')
                            }})</span>{% endif %}
                    </label>
                    <input type="password" id="password" name="password" {% if not user %}required{% endif %}
                        class="w-full px-3 py-2 border border-secondary-200 rounded-lg focus:ring-accent-500 focus:border-accent-500 bg-bg-base"
                        placeholder="{{ _('Enter password') }}" minlength="6">
                </div>

                <!-- Confirm Password -->
                <div>
                    <label for="confirm_password" class="block text-sm font-medium text-fg-base mb-1">
                        {{ _('Confirm Password') }}
                        {% if not user %}<span class="text-btn-danger-bg">*</span>{% endif %}
                    </label>
                    <input type="password" id="confirm_password" name="confirm_password" {% if not user %}required{%
                        endif %}
                        class="w-full px-3 py-2 border border-secondary-200 rounded-lg focus:ring-accent-500 focus:border-accent-500 bg-bg-base"
                        placeholder="{{ _('Confirm password') }}" minlength="6">
                </div>

                <!-- Role -->
                <div>
                    <label for="role_id" class="block text-sm font-medium text-fg-base mb-1">{{ _('Role') }} <span
                            class="text-btn-danger-bg">*</span></label>
                    <select id="role_id" name="role_id" required
                        class="w-full px-3 py-2 border border-secondary-200 rounded-lg focus:ring-accent-500 focus:border-accent-500 bg-bg-base">
                        <option value="">{{ _('Select a role') }}</option>
                        {% for role in roles %}
                        <option value="{{ role.id }}" {% if user and user.role_id==role.id %}selected{% endif %}>
                            {{ role.name }}
                        </option>
                        {% endfor %}
                    </select>
                </div>
            </div>

            <!-- Companies -->
            <div class="mb-6">
                <label class="block text-sm font-medium text-fg-base mb-3">{{ _('Companies') }} <span
                        class="text-btn-danger-bg">*</span></label>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3">
                    {% for company in companies %}
                    <div class="flex items-center">
                        <input type="checkbox" id="company_{{ company.id }}" name="company_ids" value="{{ company.id }}"
                            {% if user and company in user.companies %}checked{% endif %}
                            class="h-4 w-4 text-accent-600 focus:ring-accent-500 border-secondary-300 rounded">
                        <label for="company_{{ company.id }}" class="ml-2 block text-sm text-fg-base">
                            {{ company.name }}
                        </label>
                    </div>
                    {% endfor %}
                </div>
                {% if not companies %}
                <p class="text-fg-muted text-sm">{{ _('No companies available. Please create a company first.') }}</p>
                {% endif %}
            </div>

            <!-- Form Actions -->
            <div class="flex justify-end space-x-3">
                <a href="{{ url_for('users.index') }}"
                    class="px-4 py-2 border border-secondary-200 rounded-lg hover:bg-secondary-100 transition text-fg-base">
                    {{ _('Cancel') }}
                </a>
                <button type="submit"
                    class="bg-btn-primary-bg text-btn-primary-text px-4 py-2 rounded-lg hover:bg-btn-primary-hover transition shadow-sm">
                    {% if user %}{{ _('Update User') }}{% else %}{{ _('Create User') }}{% endif %}
                </button>
            </div>
        </form>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const passwordField = document.getElementById('password');
        const confirmPasswordField = document.getElementById('confirm_password');

        function validatePasswords() {
            if (passwordField.value && confirmPasswordField.value) {
                if (passwordField.value !== confirmPasswordField.value) {
                    confirmPasswordField.setCustomValidity('{{ _("Passwords do not match") }}');
                } else {
                    confirmPasswordField.setCustomValidity('');
                }
            }
        }

        passwordField.addEventListener('input', validatePasswords);
        confirmPasswordField.addEventListener('input', validatePasswords);

        // Company selection validation
        const form = document.querySelector('form');
        form.addEventListener('submit', function (e) {
            const checkedCompanies = document.querySelectorAll('input[name="company_ids"]:checked');
            if (checkedCompanies.length === 0) {
                e.preventDefault();
                alert('{{ _("Please select at least one company") }}');
            }
        });
    });
</script>
{% endblock %}