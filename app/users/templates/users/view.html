{% extends "base.html" %}

{% block title %}{{ user.name }} - {{ _('Business Management System') }}{% endblock %}

{% block content %}
<div class="animate-fadeIn">
    <div class="flex justify-between items-center mb-6">
        <div>
            <h2 class="text-2xl font-bold text-fg-base">{{ user.name }}</h2>
            <p class="text-fg-muted text-sm mt-1">{{ _('User details and information') }}</p>
        </div>
        <div class="flex space-x-3">
            <a href="{{ url_for('users.edit', id=user.id) }}"
                class="bg-btn-primary-bg text-btn-primary-text px-4 py-2 rounded-lg hover:bg-btn-primary-hover transition shadow-sm flex items-center">
                <i class="fas fa-edit mr-2"></i> {{ _('Edit User') }}
            </a>
            <a href="{{ url_for('users.index') }}"
                class="bg-btn-secondary-bg text-btn-secondary-text px-4 py-2 rounded-lg hover:bg-btn-secondary-hover transition flex items-center">
                <i class="fas fa-arrow-left mr-2"></i> {{ _('Back to Users') }}
            </a>
        </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <!-- User Information -->
        <div class="lg:col-span-2">
            <div class="bg-bg-subtle rounded-xl shadow-sm p-6 border border-secondary-200 mb-6">
                <h3 class="text-lg font-medium text-fg-base mb-4">{{ _('User Information') }}</h3>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <dt class="text-sm font-medium text-fg-muted">{{ _('Full Name') }}</dt>
                        <dd class="mt-1 text-sm text-fg-base">{{ user.name }}</dd>
                    </div>

                    <div>
                        <dt class="text-sm font-medium text-fg-muted">{{ _('Email Address') }}</dt>
                        <dd class="mt-1 text-sm text-fg-base">{{ user.email }}</dd>
                    </div>

                    <div>
                        <dt class="text-sm font-medium text-fg-muted">{{ _('Status') }}</dt>
                        <dd class="mt-1">
                            {% if user.active %}
                            <span
                                class="px-2 py-1 text-xs rounded-full bg-green-100 text-green-800 flex items-center w-fit">
                                <i class="fas fa-check-circle mr-1"></i>
                                {{ _('Active') }}
                            </span>
                            {% else %}
                            <span
                                class="px-2 py-1 text-xs rounded-full bg-red-100 text-red-800 flex items-center w-fit">
                                <i class="fas fa-times-circle mr-1"></i>
                                {{ _('Inactive') }}
                            </span>
                            {% endif %}
                        </dd>
                    </div>

                    <div>
                        <dt class="text-sm font-medium text-fg-muted">{{ _('Role') }}</dt>
                        <dd class="mt-1">
                            {% if user.role %}
                            <span class="px-2 py-1 text-xs rounded-full bg-accent-100 text-accent-800">
                                {{ user.role.name }}
                            </span>
                            {% else %}
                            <span class="px-2 py-1 text-xs rounded-full bg-secondary-100 text-secondary-800">
                                {{ _('No Role Assigned') }}
                            </span>
                            {% endif %}
                        </dd>
                    </div>

                    <div>
                        <dt class="text-sm font-medium text-fg-muted">{{ _('Account Created') }}</dt>
                        <dd class="mt-1 text-sm text-fg-base">
                            {{ user.created_at.strftime('%B %d, %Y at %I:%M %p') if user.created_at else _('Unknown') }}
                        </dd>
                    </div>

                    <div>
                        <dt class="text-sm font-medium text-fg-muted">{{ _('Last Updated') }}</dt>
                        <dd class="mt-1 text-sm text-fg-base">
                            {{ user.updated_at.strftime('%B %d, %Y at %I:%M %p') if user.updated_at else _('Never') }}
                        </dd>
                    </div>
                </div>
            </div>

            <!-- Companies -->
            <div class="bg-bg-subtle rounded-xl shadow-sm p-6 border border-secondary-200">
                <h3 class="text-lg font-medium text-fg-base mb-4">{{ _('Associated Companies') }}</h3>

                {% if user.companies %}
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    {% for company in user.companies %}
                    <div class="bg-bg-base border border-secondary-200 rounded-lg p-4">
                        <div class="flex items-center">
                            <div
                                class="flex-shrink-0 h-10 w-10 bg-accent-500 rounded-lg flex items-center justify-center text-btn-primary-text font-medium">
                                {{ company.name[0].upper() }}
                            </div>
                            <div class="ml-3">
                                <h4 class="text-sm font-medium text-fg-base">{{ company.name }}</h4>
                                <p class="text-xs text-fg-muted">{{ _('Member since') }} {{
                                    company.created_at.strftime('%Y-%m-%d') if company.created_at else _('Unknown') }}
                                </p>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <div class="text-center py-6">
                    <div
                        class="w-16 h-16 bg-secondary-100 rounded-full flex items-center justify-center text-secondary-400 mx-auto mb-3">
                        <i class="fas fa-building text-xl"></i>
                    </div>
                    <p class="text-fg-muted">{{ _('No companies assigned') }}</p>
                    <a href="{{ url_for('users.edit', id=user.id) }}"
                        class="text-accent-600 hover:text-accent-700 text-sm font-medium mt-2 inline-block">
                        {{ _('Assign Companies') }}
                    </a>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- User Stats & Actions -->
        <div class="space-y-6">
            <!-- Quick Stats -->
            <div class="bg-bg-subtle rounded-xl shadow-sm p-6 border border-secondary-200">
                <h3 class="text-lg font-medium text-fg-base mb-4">{{ _('Quick Stats') }}</h3>

                <div class="space-y-4">
                    <div class="flex justify-between items-center">
                        <span class="text-fg-muted text-sm">{{ _('Companies') }}</span>
                        <span class="font-medium text-fg-base">{{ user.companies|length }}</span>
                    </div>

                    <div class="flex justify-between items-center">
                        <span class="text-fg-muted text-sm">{{ _('Account Age') }}</span>
                        <span class="font-medium text-fg-base">
                            {% if user.created_at %}
                            {% set days = account_age_days %}
                            {% if days == 0 %}
                            {{ _('Today') }}
                            {% elif days == 1 %}
                            {{ _('1 day') }}
                            {% else %}
                            {{ days }} {{ _('days') }}
                            {% endif %}
                            {% else %}
                            {{ _('Unknown') }}
                            {% endif %}
                        </span>
                    </div>

                    <div class="flex justify-between items-center">
                        <span class="text-fg-muted text-sm">{{ _('Role Permissions') }}</span>
                        <span class="font-medium text-fg-base">
                            {% if user.role and user.role.permissions %}
                            {{ user.role.permissions|length }}
                            {% else %}
                            0
                            {% endif %}
                        </span>
                    </div>
                </div>
            </div>

            <!-- Role Permissions -->
            {% if user.role and user.role.permissions %}
            <div class="bg-bg-subtle rounded-xl shadow-sm p-6 border border-secondary-200">
                <h3 class="text-lg font-medium text-fg-base mb-4">{{ _('Role Permissions') }}</h3>

                <div class="space-y-2">
                    {% for permission in user.role.permissions %}
                    <div class="flex items-center">
                        <i class="fas fa-check text-green-500 text-xs mr-2"></i>
                        <span class="text-sm text-fg-base">{{ permission.name }}</span>
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endif %}

            <!-- Actions -->
            <div class="bg-bg-subtle rounded-xl shadow-sm p-6 border border-secondary-200">
                <h3 class="text-lg font-medium text-fg-base mb-4">{{ _('Actions') }}</h3>

                <div class="space-y-3">
                    <a href="{{ url_for('users.edit', id=user.id) }}"
                        class="w-full bg-btn-primary-bg text-btn-primary-text px-4 py-2 rounded-lg hover:bg-btn-primary-hover transition text-center block">
                        <i class="fas fa-edit mr-2"></i> {{ _('Edit User') }}
                    </a>

                    {% if user.id != current_user.id %}
                    <button onclick="toggleUserStatus({{ user.id }}, {{ user.active|lower }})"
                        class="w-full {% if user.active %}bg-orange-600 hover:bg-orange-700{% else %}bg-green-600 hover:bg-green-700{% endif %} text-white px-4 py-2 rounded-lg transition">
                        <i class="fas {% if user.active %}fa-user-slash{% else %}fa-user-check{% endif %} mr-2"></i>
                        {% if user.active %}{{ _('Deactivate User') }}{% else %}{{ _('Activate User') }}{% endif %}
                    </button>

                    <button onclick="sendPasswordReset({{ user.id }})"
                        class="w-full bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition">
                        <i class="fas fa-key mr-2"></i> {{ _('Send Password Reset') }}
                    </button>

                    <form action="{{ url_for('users.delete', id=user.id) }}" method="POST"
                        onsubmit="return confirm('{{ _('Are you sure you want to delete this user? This action cannot be undone.') }}')">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                        <button type="submit"
                            class="w-full bg-btn-danger-bg text-btn-danger-text px-4 py-2 rounded-lg hover:bg-btn-danger-hover transition">
                            <i class="fas fa-trash mr-2"></i> {{ _('Delete User') }}
                        </button>
                    </form>
                    {% else %}
                    <div class="text-center py-2 text-fg-muted text-sm">
                        {{ _('You cannot modify your own account status') }}
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Toast Notification -->
<div id="toast" class="fixed top-4 right-4 z-50 hidden">
    <div class="bg-bg-subtle border border-secondary-200 rounded-lg shadow-lg p-4 max-w-sm">
        <div class="flex items-center">
            <div id="toast-icon" class="flex-shrink-0 mr-3"></div>
            <div id="toast-message" class="text-sm text-fg-base"></div>
        </div>
    </div>
</div>

<script>
    function showToast(message, type = 'success') {
        const toast = document.getElementById('toast');
        const icon = document.getElementById('toast-icon');
        const messageEl = document.getElementById('toast-message');

        messageEl.textContent = message;

        if (type === 'success') {
            icon.innerHTML = '<i class="fas fa-check-circle text-green-500"></i>';
        } else {
            icon.innerHTML = '<i class="fas fa-exclamation-circle text-red-500"></i>';
        }

        toast.classList.remove('hidden');

        setTimeout(() => {
            toast.classList.add('hidden');
        }, 5000);
    }

    function toggleUserStatus(userId, currentStatus) {
        const action = currentStatus ? 'deactivate' : 'activate';

        if (!confirm(`Are you sure you want to ${action} this user?`)) {
            return;
        }

        fetch(`/users/${userId}/toggle-status`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token() }}'
            }
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showToast(data.message, 'success');
                    // Reload page to update UI
                    setTimeout(() => {
                        window.location.reload();
                    }, 1000);
                } else {
                    showToast(data.message, 'error');
                }
            })
            .catch(error => {
                showToast('An error occurred while updating user status', 'error');
            });
    }

    function sendPasswordReset(userId) {
        if (!confirm('Send password reset email to this user?')) {
            return;
        }

        fetch(`/users/${userId}/send-password-reset`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token() }}'
            }
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showToast(data.message, 'success');
                } else {
                    showToast(data.message, 'error');
                }
            })
            .catch(error => {
                showToast('An error occurred while sending password reset email', 'error');
            });
    }
</script>
{% endblock %}