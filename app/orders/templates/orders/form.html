{% extends "base.html" %}

{% block title %}{% if order %}{{ _('Edit Purchase Order') }}{% else %}{{ _('Create Purchase Order') }}{% endif %} - {{
_('Business Management System') }}{% endblock %}

{% block content %}
<!-- Header -->
<div class="mb-6">
    <div class="flex items-center space-x-4 mb-4">
        <a href="{{ url_for('orders.index', company_id=company_id) }}"
            class="text-fg-muted hover:text-fg-base transition">
            <i class="fas fa-arrow-left"></i>
        </a>
        <div>
            <h2 class="text-2xl font-bold text-fg-base">
                {% if order %}{{ _('Edit Purchase Order') }}{% else %}{{ _('Create Purchase Order') }}{% endif %}
            </h2>
            <p class="text-fg-muted text-sm mt-1">
                {% if order %}{{ _('Update purchase order details') }}{% else %}{{ _('Create a new purchase order') }}{%
                endif %}
            </p>
        </div>
    </div>
</div>

<!-- Form -->
<div class="bg-bg-subtle rounded-xl shadow-sm border border-primary-200">
    <form method="POST" class="p-6" id="purchase-order-form"
        action="{{ url_for('orders.update', company_id=company_id, id=order.id) if order else url_for('orders.create', company_id=company_id) }}">
        <input type="hidden" id="currencySymbol" value="{{ session.get('currency') }}">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

        <!-- Supplier Selection -->
        <div class="mb-8">
            <div class="bg-bg-base rounded-lg p-4 border border-primary-200">
                <h3 class="text-lg font-medium text-fg-base mb-4">{{ _('Order Information') }}</h3>

                {% if order %}
                <div class="mb-4">
                    <label class="block text-sm font-medium text-fg-base mb-2">{{ _('Order Number') }}</label>
                    <p class="text-lg font-mono text-fg-base">{{ order.order_number }}</p>
                </div>
                {% endif %}

                <div>
                    <label for="supplier_id" class="block text-sm font-medium text-fg-base mb-2">
                        {{ _('Supplier') }} <span class="text-btn-danger-bg">*</span>
                    </label>
                    <select id="supplier_id" name="supplier_id" required
                        class="w-full px-3 py-2 border border-primary-300 rounded-lg focus:ring-accent-500 focus:border-accent-500 bg-bg-base text-fg-base">
                        <option value="">{{ _('Select a supplier') }}</option>
                        {% for supplier in suppliers %}
                        {% set selected_supplier = order.supplier_id if order else (form_data.supplier_id if form_data
                        else '') %}
                        <option value="{{ supplier.id }}" {% if selected_supplier|string==supplier.id|string
                            %}selected{% endif %}>
                            {{ supplier.name }}
                        </option>
                        {% endfor %}
                    </select>
                    {% if not suppliers %}
                    <p class="text-xs text-fg-muted mt-1">
                        {{ _('No suppliers available.') }}
                        <a href="{{ url_for('suppliers.create', company_id=company_id) }}"
                            class="text-accent-600 hover:text-accent-700">{{ _('Add a supplier') }}</a>
                    </p>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Items Section -->
        <div class="mb-8">
            <div class="bg-bg-base rounded-lg p-4 border border-primary-200">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-medium text-fg-base">{{ _('Order Items') }}</h3>
                    <button type="button" id="add-item-btn"
                        class="bg-accent-500 text-accent-900 px-3 py-2 rounded-lg hover:bg-accent-600 transition text-sm">
                        <i class="fas fa-plus mr-1"></i>{{ _('Add Item') }}
                    </button>
                </div>

                <!-- Replaced select dropdowns with product picker modal interface -->
                <div class="border border-primary-200 rounded-lg overflow-hidden">
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-primary-200">
                            <thead class="bg-primary-50 sticky top-0">
                                <tr>
                                    <th
                                        class="px-4 py-3 text-left text-xs font-medium text-fg-muted uppercase tracking-wider min-w-[200px]">
                                        {{ _('Item') }}
                                    </th>
                                    <th
                                        class="px-4 py-3 text-left text-xs font-medium text-fg-muted uppercase tracking-wider w-24">
                                        {{ _('Code') }}
                                    </th>
                                    <th
                                        class="px-4 py-3 text-left text-xs font-medium text-fg-muted uppercase tracking-wider w-24">
                                        {{ _('Qty') }}
                                    </th>
                                    <th
                                        class="px-4 py-3 text-left text-xs font-medium text-fg-muted uppercase tracking-wider w-32">
                                        {{ _('Unit Price') }}
                                    </th>
                                    <th
                                        class="px-4 py-3 text-left text-xs font-medium text-fg-muted uppercase tracking-wider w-32">
                                        {{ _('Total') }}
                                    </th>
                                    <th
                                        class="px-4 py-3 text-center text-xs font-medium text-fg-muted uppercase tracking-wider w-16">
                                        {{ _('Action') }}
                                    </th>
                                </tr>
                            </thead>
                            <tbody id="items-container" class="bg-bg-base divide-y divide-primary-200">
                                {% if order and order.items %}
                                {% for item in order.items %}
                                <tr class="item-row hover:bg-primary-50"
                                    data-item-id="{{ item.inventory_item_id or '' }}">
                                    <td class="px-4 py-3">
                                        <input type="hidden" name="items[{{ loop.index0 }}][inventory_item_id]"
                                            value="{{ item.inventory_item_id or '' }}" class="item-id-input">
                                        <button type="button"
                                            class="select-product-btn w-full px-3 py-2 text-left text-sm border border-primary-300 rounded-lg hover:bg-primary-50 focus:ring-accent-500 focus:border-accent-500 bg-bg-base text-fg-base flex items-center justify-between">
                                            <span class="product-name">{{ item.inventory_item.name if
                                                item.inventory_item else _('Select a product') }}</span>
                                            <i class="fas fa-search text-fg-muted text-xs"></i>
                                        </button>
                                    </td>
                                    <td class="px-4 py-3">
                                        <input type="text" name="items[{{ loop.index0 }}][code]" value="{{ item.item_code }}"
                                            class="code-input w-full px-2 py-1 text-sm border border-primary-300 rounded focus:ring-accent-500 focus:border-accent-500 bg-bg-base text-fg-base">
                                    </td>
                                    <td class="px-4 py-3">
                                        <input type="number" name="items[{{ loop.index0 }}][quantity]"
                                            value="{{ item.quantity }}" min="1"
                                            class="w-full px-2 py-1 text-sm border border-primary-300 rounded focus:ring-accent-500 focus:border-accent-500 item-quantity bg-bg-base text-fg-base">
                                    </td>
                                    <td class="px-4 py-3">
                                        <input type="number" name="items[{{ loop.index0 }}][price]"
                                            value="{{ item.price }}" min="0" step="0.01"
                                            class="w-full px-2 py-1 text-sm border border-primary-300 rounded focus:ring-accent-500 focus:border-accent-500 item-price bg-bg-base text-fg-base">
                                    </td>
                                    <td class="px-4 py-3">
                                        <div class="item-total font-medium text-fg-base text-sm">
                                            {{ session.get('currency') }}{{ "{:,.2f}".format((item.quantity or 0) *
                                            (item.price or 0)) }}
                                        </div>
                                    </td>
                                    <td class="px-4 py-3 text-center">
                                        <button type="button"
                                            class="text-btn-danger-bg hover:text-btn-danger-hover remove-item p-1 rounded">
                                            <i class="fas fa-trash text-sm"></i>
                                        </button>
                                    </td>
                                </tr>
                                {% endfor %}
                                {% else %}
                                <tr class="item-row hover:bg-primary-50" data-item-id="">
                                    <td class="px-4 py-3">
                                        <input type="hidden" name="items[0][inventory_item_id]" value=""
                                            class="item-id-input">
                                        <button type="button"
                                            class="select-product-btn w-full px-3 py-2 text-left text-sm border border-primary-300 rounded-lg hover:bg-primary-50 focus:ring-accent-500 focus:border-accent-500 bg-bg-base text-fg-base flex items-center justify-between">
                                            <span class="product-name text-fg-muted">{{ _('Select a product') }}</span>
                                            <i class="fas fa-search text-fg-muted text-xs"></i>
                                        </button>
                                    </td>
                                    <td class="px-4 py-3">
                                        <input type="text" name="items[0][code]"
                                            class="code-input w-full px-2 py-1 text-sm border border-primary-300 rounded focus:ring-accent-500 focus:border-accent-500 bg-bg-base text-fg-base">
                                    </td>
                                    <td class="px-4 py-3">
                                        <input type="number" name="items[0][quantity]" value="1" min="1"
                                            class="w-full px-2 py-1 text-sm border border-primary-300 rounded focus:ring-accent-500 focus:border-accent-500 item-quantity bg-bg-base text-fg-base">
                                    </td>
                                    <td class="px-4 py-3">
                                        <input type="number" name="items[0][price]" value="0.00" min="0" step="0.01"
                                            class="w-full px-2 py-1 text-sm border border-primary-300 rounded focus:ring-accent-500 focus:border-accent-500 item-price bg-bg-base text-fg-base">
                                    </td>
                                    <td class="px-4 py-3">
                                        <div class="item-total font-medium text-fg-base text-sm">{{
                                            session.get('currency') }}0.00</div>
                                    </td>
                                    <td class="px-4 py-3 text-center">
                                        <button type="button"
                                            class="text-btn-danger-bg hover:text-btn-danger-hover remove-item p-1 rounded">
                                            <i class="fas fa-trash text-sm"></i>
                                        </button>
                                    </td>
                                </tr>
                                {% endif %}
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Order Total -->
                <div class="mt-6 pt-4 border-t border-primary-200">
                    <div class="flex justify-end">
                        <div class="bg-accent-50 rounded-lg p-4 border border-accent-200">
                            <div class="text-right">
                                <p class="text-sm text-fg-muted">{{ _('Order Total') }}</p>
                                <p class="text-2xl font-bold text-fg-base" id="order-total">{{ session.get('currency')
                                    }}0.00</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Form Actions -->
        <div class="pt-6 border-t border-primary-200">
            <div class="flex justify-end space-x-3">
                <a href="{{ url_for('orders.index', company_id=company_id) }}"
                    class="px-6 py-2 border border-primary-400 rounded-lg text-btn-secondary-text bg-btn-secondary-bg hover:bg-btn-secondary-hover transition">
                    {{ _('Cancel') }}
                </a>
                <button type="submit"
                    class="px-6 py-2 bg-btn-primary-bg text-btn-primary-text rounded-lg hover:bg-btn-primary-hover transition flex items-center">
                    <i class="fas fa-save mr-2"></i>
                    {% if order %}{{ _('Update Order') }}{% else %}{{ _('Create Order') }}{% endif %}
                </button>
            </div>
        </div>
    </form>
</div>

{% include 'product-list.html' %}

<script src="{{ url_for('orders.static', filename='js/form.js') }}"></script>

{% endblock %}